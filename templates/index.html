<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Amateur</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <!-- FontAwesome removed to fix loading errors -->
</head>
<body>
  <!-- è®¾ç½®å¼¹çª— -->
  <div id="settingsPopup" class="settings-popup" style="display: none;">
    <div class="settings-popup-content">
      <div class="settings-popup-header">
        <h2>è®¾ç½®</h2>
        <span class="settings-popup-close" id="closeSettingsPopup">&times;</span>
      </div>
      <div class="settings-popup-body">
        <p>è®¾ç½®å†…å®¹å°†åœ¨ç¨åæ·»åŠ ...</p>
      </div>
    </div>
  </div>

  <div id="downloadModal" class="download-modal" style="z-index:9999;display:none;">
    <div>
      <h3>ä¸‹è½½è¿›åº¦</h3>
      <div id="downloadProgressBar" style="height:20px;background:#eee;border-radius:8px;margin-bottom:10px;">
        <div id="downloadProgress" style="height:100%;width:0%;background:#55cc88;border-radius:8px;text-align:center;color:#fff;line-height:20px;">0%</div>
      </div>
      <div id="downloadLog" style="height:180px;overflow-y:auto;background:#f7f7f7;border:1px solid #ccc;padding:10px;font-size:13px;"></div>
      <button onclick="hideDownloadModal()">å…³é—­</button>
    </div>
  </div>
  <style>
  .download-modal { position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,.17); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .download-modal > * { background:#fff; border-radius:12px; box-shadow:0 4px 16px #0001; min-width:330px; padding:24px 16px 16px 16px; }
  </style>
  <div class="container">
    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="logo">
          <img src="/static/images/logo.png" alt="Logo" />
        </div>
        <div class="app-name">Amateur</div>
      </div>

      <div class="sidebar-content">
        <!-- æ·»åŠ ä¸»é¡µæŒ‰é’® -->
        <div class="menu-item" data-page="home">
          <div class="menu-icon"><img src="/static/images/home.png" alt="home" /></div>
          <div class="menu-label">ä¸»é¡µ</div>
        </div>
        <!-- æ·»åŠ åŠŸèƒ½æŒ‰é’® -->
        <div class="menu-item" data-page="tools">
          <div class="menu-icon"><img src="/static/images/tool.png" alt="tool" /></div>
          <div class="menu-label">åŠŸèƒ½</div>
        </div>
        <!-- æ·»åŠ  AI å¯¹è¯æŒ‰é’® -->
        <div class="menu-item" data-page="chat">
          <div class="menu-icon"><img src="/static/images/chat.png" alt="chat" /></div>
          <div class="menu-label">AI å¯¹è¯</div>
        </div>
        <!-- æ·»åŠ å…³äºæŒ‰é’® -->
        <div class="menu-item" data-page="about">
          <div class="menu-icon"><img src="/static/images/about.png" alt="about" /></div>
          <div class="menu-label">å…³äº</div>
        </div>
      </div>
    </aside>
    <!-- èœå•æŒ‰é’®å®¹å™¨ -->
    <div class="menu-button-container">
      <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
      <div class="theme-toggle-button" id="themeToggleButton">
        <div class="theme-icon">
          <img src="/static/images/setting.png" alt="ä¸»é¢˜åˆ‡æ¢" />
        </div>
      </div>
      
      <!-- èœå•è®¾ç½®æŒ‰é’® -->
      <div class="menu-settings-button" id="menusettingsButton">
        <div class="menu-settings-icon">
          <img src="/static/images/setting.png" alt="è®¾ç½®" />
        </div>
      </div>
    </div>

    <!-- å³ä¾§ä¸»è¦å†…å®¹åŒº -->
    <main class="main-box">
      <div class="main-content"></div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script>
  // æŠ–éŸ³å¼¹çª—æ§åˆ¶å‡½æ•°
  function openDouyinModal() {
    const modal = document.getElementById('douyinModal');
    modal.style.display = 'flex';
    setTimeout(() => {
      modal.classList.add('show');
    }, 10);
  }
  
  function closeDouyinModal() {
    const modal = document.getElementById('douyinModal');
    modal.classList.remove('show');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
  }
  
  // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
  document.addEventListener('click', function(e) {
    const modal = document.getElementById('douyinModal');
    if (e.target === modal) {
      closeDouyinModal();
    }
  });
  
  // ESCé”®å…³é—­å¼¹çª—
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeDouyinModal();
      // å…³é—­è®¾ç½®å¼¹çª—
      const settingsPopup = document.getElementById('settingsPopup');
      if (settingsPopup && settingsPopup.style.display === 'flex') {
        settingsPopup.classList.remove('show');
        setTimeout(() => {
          settingsPopup.style.display = 'none';
        }, 300);
      }
    }
  });
  
  document.addEventListener('DOMContentLoaded', function() {
    let chatHistory = []; // å­˜å‚¨èŠå¤©å†…å®¹
    let currentFilename = null;    // å½“å‰èŠå¤©çš„å†å²æ–‡ä»¶å
    let hasUnsavedChanges = false; // å½“å‰èŠå¤©å†…å®¹æ˜¯å¦æœ‰æœªä¿å­˜æ›´æ”¹
    let hasDeletedOriginal = false;// æ˜¯å¦å·²ç»åˆ é™¤è¿‡åŸæœ‰èŠå¤©æ–‡ä»¶ï¼ˆé˜²æ­¢é‡å¤åˆ ï¼‰
    let isSaving = false; // é˜²æ­¢é‡å¤ä¿å­˜çš„æ ‡å¿—
    let douyinFormCache = {}; // å­˜å‚¨è§†é¢‘ä¸‹è½½è¡¨å•
    
    // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
    let currentTheme = 'pink'; // é»˜è®¤ç²‰è‰²ä¸»é¢˜
    const themeToggleButton = document.getElementById('themeToggleButton');
    
    function switchTheme() {
      const body = document.body;
      const themeButton = document.querySelector('.theme-toggle-button');
      const themeIcon = themeButton.querySelector('img');
      
      if (currentTheme === 'pink') {
        // åˆ‡æ¢åˆ°è“è‰²ä¸»é¢˜
        body.classList.remove('pink-theme');
        body.classList.add('blue-theme');
        themeButton.style.background = 'linear-gradient(135deg, #4a90e2 0%, #357abd 100%)';
        themeIcon.src = '/static/images/moon.svg';
        themeIcon.alt = 'æœˆäº®';
        currentTheme = 'blue';
      } else {
        // åˆ‡æ¢åˆ°ç²‰è‰²ä¸»é¢˜
        body.classList.remove('blue-theme');
        body.classList.add('pink-theme');
        themeButton.style.background = 'linear-gradient(135deg, #ffb3d9 0%, #ff99cc 100%)';
        themeIcon.src = '/static/images/sun.svg';
        themeIcon.alt = 'å¤ªé˜³';
        currentTheme = 'pink';
      }
    }
    
    // åˆå§‹åŒ–é»˜è®¤ä¸»é¢˜
    document.body.classList.add('pink-theme');
    // åˆå§‹åŒ–æŒ‰é’®é¢œè‰²å’Œå›¾æ ‡ï¼ˆç²‰è‰²ä¸»é¢˜ä¸‹æŒ‰é’®æ˜¾ç¤ºç²‰è‰²ï¼Œå›¾æ ‡ä¸ºå¤ªé˜³ï¼‰
    if (themeToggleButton) {
      themeToggleButton.style.background = 'linear-gradient(135deg, #ffb3d9 0%, #ff99cc 100%)';
      const themeIcon = themeToggleButton.querySelector('img');
      if (themeIcon) {
        themeIcon.src = '/static/images/sun.svg';
        themeIcon.alt = 'å¤ªé˜³';
      }
    }
    
    if (themeToggleButton) {
      themeToggleButton.addEventListener('click', switchTheme);
    }
    
    // è®¾ç½®æŒ‰é’®äº‹ä»¶å¤„ç†
    const menusettingsButton = document.getElementById('menusettingsButton');
    const settingsPopup = document.getElementById('settingsPopup');
    const closeSettingsPopup = document.getElementById('closeSettingsPopup');
    
    if (menusettingsButton) {
      menusettingsButton.addEventListener('click', function() {
        settingsPopup.style.display = 'flex';
        setTimeout(() => {
          settingsPopup.classList.add('show');
        }, 10);
      });
    }
    
    if (closeSettingsPopup) {
      closeSettingsPopup.addEventListener('click', function() {
        settingsPopup.classList.remove('show');
        setTimeout(() => {
          settingsPopup.style.display = 'none';
        }, 300);
      });
    }
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­è®¾ç½®å¼¹çª—
    if (settingsPopup) {
      settingsPopup.addEventListener('click', function(e) {
        if (e.target === settingsPopup) {
          settingsPopup.classList.remove('show');
          setTimeout(() => {
            settingsPopup.style.display = 'none';
          }, 300);
        }
      });
    }

      const menuItems = document.querySelectorAll('.menu-item');
      const mainContent = document.querySelector('.main-content');
    
      const pages = {
        home: `<iframe src="https://hzihao.icu" class="iframe-content"></iframe>
                <div class="main-tail">
                  <a href="https://hzihao.icu" target="_blank"><p>Amateurå‘ç”µçš„åœ°æ–¹</p></a>
                </div>`,
        tools: `<div class="main-header fade-in">
                  <h2>ä¸€äº›å¯èƒ½æœ‰ç”¨çš„ç©æ„</h2>
                </div>
                <div class="cards-wrapper" id="cards-wrapper">
                  <div class="card"><img src="/static/images/ela.png" alt="å›¾ç‰‡1"></div>
                  <div class="card douyin-card" onclick="openDouyinModal()" style="cursor: pointer;">
                    <img src="/static/images/tiktok_card.png" alt="æŠ–éŸ³è§†é¢‘ä¸‹è½½" style="width: 100%; height: 100%; object-fit: cover; border-radius: 16px;">
                    <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 8px; font-weight: 600; color: #2c3e50;">æŠ–éŸ³è§†é¢‘ä¸‹è½½</div>
                  </div>
                  <div class="card"><img src="/static/images/ela.png" alt="å›¾ç‰‡3"></div>
                </div>
                
                <!-- æŠ–éŸ³ä¸‹è½½å¼¹çª— -->
                <div id="douyinModal" class="douyin-modal" style="display: none;">
                  <div class="douyin-modal-content">
                    <div class="douyin-modal-header">
                      <h2>æŠ–éŸ³è§†é¢‘ä¸‹è½½</h2>
                      <button id="openDownloadPathBtn" class="open-path-btn" onclick="openDownloadPath()" title="æ‰“å¼€ä¸‹è½½è·¯å¾„">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2z"></path>
                        </svg>
                        æ‰“å¼€è·¯å¾„
                      </button>
                      <span class="douyin-modal-close" onclick="closeDouyinModal()">&times;</span>
                    </div>
                    
                    <!-- åˆ‡æ¢æŒ‰é’® -->
                    <div class="douyin-tab-buttons" style="display: flex; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px;">
                      <button type="button" class="douyin-tab-btn active" data-tab="homepage" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: 500; border-bottom: 2px solid #007bff;">ä¸»é¡µè§†é¢‘</button>
                      <button type="button" class="douyin-tab-btn" data-tab="specific" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent;">æŒ‡å®šè§†é¢‘</button>
                    </div>
                    
                    <!-- ä¸»é¡µè§†é¢‘è¡¨å• -->
                    <form id="douyin-download-form" class="douyin-form-content" data-form="homepage" style="display: flex; flex-direction: column; gap: 22px; padding: 0 20px 20px 20px;">
                      <label>
                        <span style="font-weight:500;">sec_user_id(ä¸»é¡µé“¾æ¥ä¸­'user/'åçš„å­—ç¬¦ä¸²MS4å¼€å¤´)</span>
                        <input type="text" name="sec_user_id" id="sec_user_id" class="input-field" placeholder="è¯·è¾“å…¥sec_user_id" required>
                      </label>
                      <label>
                        <span style="font-weight:500;">cookies</span>
                        <input type="text" name="cookies" id="cookies" class="input-field" placeholder="æ”¾ç©ºåˆ™è¿›è¡Œæ‰«ç è‡ªåŠ¨å¡«å……">
                      </label>
                      <label>
                        <span style="font-weight:500;">msToken</span>
                        <input type="text" name="msToken" id="msToken" class="input-field" placeholder="æ”¾ç©ºåˆ™è¿›è¡Œæ‰«ç è‡ªåŠ¨å¡«å……">
                      </label>
                      <label>
                        <span style="font-weight:500;">æœ€å¤§ä¸‹è½½è§†é¢‘æ•°</span>
                        <input type="number" name="max_dloads" id="max_dloads" class="input-field" placeholder="è¯·è¾“å…¥æœ€å¤§ä¸‹è½½è§†é¢‘æ•°" min="1" required value="10">
                      </label>
                      <div style="display: flex; flex-direction: row; gap: 18px;">
                        <button type="submit" id="start_dload" class="main-btn" style="flex: 7;">å¼€å§‹ä¸‹è½½</button>
                        <button type="button" id="saveConfigBtn" class="main-btn" style="flex: 3;">ä¿å­˜</button>
                      </div>
                    </form>
                    
                    <!-- æŒ‡å®šè§†é¢‘è¡¨å• -->
                    <form id="douyin-specific-form" class="douyin-form-content" data-form="specific" style="display: none; flex-direction: column; gap: 22px; padding: 0 20px 20px 20px;">
                      <label>
                        <span style="font-weight:500;">è§†é¢‘åˆ†äº«é“¾æ¥</span>
                        <input type="text" name="share_url" id="share_url" class="input-field" placeholder="è¯·è¾“å…¥è§†é¢‘åˆ†äº«é“¾æ¥" required>
                      </label>
                      <label>
                        <span style="font-weight:500;">cookies</span>
                        <input type="text" name="cookies_specific" id="cookies_specific" class="input-field" placeholder="æ”¾ç©ºåˆ™è¿›è¡Œæ‰«ç è‡ªåŠ¨å¡«å……">
                      </label>
                      <label>
                        <span style="font-weight:500;">msToken</span>
                        <input type="text" name="msToken_specific" id="msToken_specific" class="input-field" placeholder="æ”¾ç©ºåˆ™è¿›è¡Œæ‰«ç è‡ªåŠ¨å¡«å……">
                      </label>
                      <div style="display: flex; flex-direction: row; gap: 18px;">
                        <button type="submit" id="start_dload_specific" class="main-btn" style="flex: 7;">å¼€å§‹ä¸‹è½½</button>
                        <button type="button" id="saveConfigBtn_specific" class="main-btn" style="flex: 3;">ä¿å­˜</button>
                      </div>
                    </form>

                  </div>
                </div>`,
        chat: `<div class="chat-container">
                <div class="button-container">
                  <button class="button-item" id="newChatButton">
                    <div class="button-icon">
                      <img src="/static/images/newchat.png" alt="newchat">
                    </div>
                    æ–°èŠå¤©
                  </button>

                  <button class="button-item" id="configApiButton">
                    <div class="button-icon">
                      <img src="/static/images/setting.png" alt="setting">
                    </div>
                    é…ç½®
                  </button>

                  <button class="button-item" id="historyButton">
                    <div class="button-icon">
                      <img src="/static/images/history.png" alt="history">
                    </div>
                    å›å¿†å½•
                  </button>
                </div>
                <div class="chat-box" id="chat-box"></div>
                <div class="chat-input">
                    <input type="text" id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜">
                    <button id="sendButton">å‘é€</button>
                </div>
            </div>
            <!-- é…ç½®æ¨¡æ€æ¡† -->
            <div class="modal-overlay" id="modalOverlay"></div>
            <div class="modal" id="configModal">
                <h3>API é…ç½®</h3>
                <label>æä¾›æ–¹ï¼š
                    <select id="provider">
                        <option value="openai">OpenAI</option>
                        <option value="deepseek">DeepSeek</option> 
                    </select>
                </label>
                <br><br>
                <label>æ¨¡å‹ï¼š
                    <select id="model">
                        <!-- é»˜è®¤é€‰é¡¹ -->
                    </select>
                </label>
                <br><br>
                <label>
                    API Key:
                    <input type="text" id="apiKey" placeholder="è¾“å…¥API Key">
                </label>
                <br><br>
                <button id="saveConfig">ä¿å­˜</button>
                <button id="closeModal">å–æ¶ˆ</button>
            </div>
            <!-- å›å¿†å½•æ¨¡æ€æ¡† -->
            <div class="modal" id="historyModal">
              <h3>èŠå¤©å†å²</h3>
              <div id="historyList" style="max-height: 300px; overflow-y: auto; margin: 10px 0;"></div>
              <button id="closeHistory">å…³é—­</button>
            </div>
            <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
            <div class="modal" id="deleteConfirmModal">
              <h3 id="deleteConfirmText">ç¡®è®¤åˆ é™¤ï¼Ÿ</h3>
              <button id="confirmDeleteBtn">ç¡®è®¤</button>
              <button id="cancelDeleteBtn">å–æ¶ˆ</button>
            </div>
            `,
        about: `<div class="page-content">
                  <div class="main-header fade-in"><h2>ä¸€äº›å¯èƒ½æœ‰ç”¨çš„ä¿¡æ¯</h2></div>
                  <div class="about-content"><p>æœ¬åº”ç”¨ç”±Amateurä¸ªäººç‹¬ç«‹ä½¿ç”¨AIå¼€å‘ã€‚</p></div>
                </div>`,
      };

    if (mainContent.innerHTML.includes('douyin-download-form')) {
      // æœ‰ tools è¡¨å•ï¼Œä¿å­˜
      const form = document.getElementById('douyin-download-form');
      if (form) {
        douyinFormCache = {
          sec_user_id: form.sec_user_id.value,
          cookies: form.cookies.value,
          msToken: form.msToken.value,
          max_dloads: form.max_dloads.value,
          cookies_specific: form.cookies_specific.value,
          msToken_specific: form.msToken_specific.value,
          cookies_following: form.cookies_following.value,
          msToken_following: form.msToken_following.value,
          max_following_dloads: form.max_following_dloads.value,
          share_url: form.share_url.value,
        };
      }
    }

    // é»˜è®¤æ˜¾ç¤ºä¸»é¡µ
    mainContent.innerHTML = pages.home;
    menuItems[0].classList.add('active');
    
    // ç»‘å®šå¯¼èˆªæ ç‚¹å‡»äº‹ä»¶
    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        menuItems.forEach(mi => mi.classList.remove('active'));
        item.classList.add('active');
        const page = item.getAttribute('data-page');

        mainContent.innerHTML = pages[page];

        if (page ==="tools") {
          // æ·»åŠ åˆ‡æ¢æŒ‰é’®åŠŸèƒ½
          const tabButtons = document.querySelectorAll('.douyin-tab-btn');
          const formContents = document.querySelectorAll('.douyin-form-content');
          
          // åˆ‡æ¢è¡¨å•æ˜¾ç¤º
          function switchTab(tabName) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            tabButtons.forEach(btn => {
              btn.classList.remove('active');
              btn.style.borderBottomColor = 'transparent';
            });
            
            // éšè—æ‰€æœ‰è¡¨å•
            formContents.forEach(form => {
              form.style.display = 'none';
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„è¡¨å•
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            const activeForm = document.querySelector(`[data-form="${tabName}"]`);
            
            if (activeBtn && activeForm) {
              activeBtn.classList.add('active');
              activeBtn.style.borderBottomColor = '#007bff';
              activeForm.style.display = 'flex';
            }
          }
          
          // ç»‘å®šåˆ‡æ¢æŒ‰é’®äº‹ä»¶
          tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
              const tabName = btn.getAttribute('data-tab');
              switchTab(tabName);
            });
          });
          
          // é…ç½®ç®¡ç†
          const sec_user_id = document.getElementById("sec_user_id");
          const cookies = document.getElementById("cookies");
          const msToken = document.getElementById("msToken");
          const max_dloads = document.getElementById("max_dloads");
          
          // æŒ‡å®šè§†é¢‘è¡¨å•å…ƒç´ 
          const share_url = document.getElementById("share_url");
          const cookies_specific = document.getElementById("cookies_specific");
          const msToken_specific = document.getElementById("msToken_specific");

          // è·å–è§†é¢‘ä¸‹è½½å‚æ•°
          fetch('/get_config')
          .then(response => response.json())
          .then(data => {
            // ä¸»é¡µè§†é¢‘è¡¨å•
            if(data.tools && data.tools.cookies) cookies.value = data.tools.cookies
            if(data.tools && data.tools.msToken) msToken.value = data.tools.msToken
            if(data.tools && data.tools.sec_user_id) sec_user_id.value = data.tools.sec_user_id;
            if(data.tools && data.tools.max_dloads) max_dloads.value = data.tools.max_dloads;
            
            // æŒ‡å®šè§†é¢‘è¡¨å•
            if(data.tools && data.tools.cookies && cookies_specific) cookies_specific.value = data.tools.cookies;
            if(data.tools && data.tools.msToken && msToken_specific) msToken_specific.value = data.tools.msToken;
            
            // å†ç”¨æœ¬åœ°ç¼“å­˜è¦†ç›–ï¼ˆå¦‚æœæœ‰ç¼“å­˜ï¼‰
            if (douyinFormCache) {
              if (douyinFormCache.sec_user_id) document.getElementById('sec_user_id').value = douyinFormCache.sec_user_id;
              if (douyinFormCache.cookies) document.getElementById('cookies').value = douyinFormCache.cookies;
              if(douyinFormCache.cookies_specific) document.getElementById('cookies_specific').value = douyinFormCache.cookies_specific;
              if (douyinFormCache.msToken) document.getElementById('msToken').value = douyinFormCache.msToken;
              if(douyinFormCache.msToken_specific) document.getElementById('msToken_specific').value = douyinFormCache.msToken_specific;
              if (douyinFormCache.max_dloads) document.getElementById('max_dloads').value = douyinFormCache.max_dloads;
              if(douyinFormCache.share_url) document.getElementById('share_url').value = douyinFormCache.share_url;
            }

            // ----------- ç›‘å¬è¡¨å•è¾“å…¥ï¼Œå®æ—¶å†™å…¥ç¼“å­˜ -----------
            ['sec_user_id', 'cookies', 'msToken', 'cookies_specific', 'msToken_specific',
               'cookies_following', 'msToken_following', 'max_dloads', 'max_following_dloads', 'share_url'
            ].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                el.addEventListener('input', () => {
                  douyinFormCache[id] = el.value;
                });
              }
            });
          });

          // å®šä¹‰è¡¨å•å’Œä¿å­˜æŒ‰é’®
          const userForm = document.getElementById("douyin-download-form");
          const saveConfigBtn = document.getElementById("saveConfigBtn");
          
          if (saveConfigBtn && userForm) {
            saveConfigBtn.addEventListener("click", async () => {
              const formData = new FormData(userForm);
              const data = Object.fromEntries(formData.entries());
              // ä¿å­˜å­—æ®µ
              try {
                const response = await fetch("/save_config", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                  showToast("é…ç½®å·²ä¿å­˜ï¼")
                } else {
                  showToast(result.error || "ä¿å­˜å¤±è´¥", 2500);
                }
              } catch (e) {
                showToast("ä¿å­˜è¯·æ±‚å¤±è´¥", 2500);
              }
            });
          }

          if (userForm) {
            userForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const formData = new FormData(userForm);
              const data = Object.fromEntries(formData.entries());
              if(data.cookies == "" || data.msToken == "") {
                showToast("è¯·å…ˆè¿›è¡Œæ‰«ç ç™»å½•");
                try {
                  const response = await fetch("/douyin_login",{
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                  });
                  showToast("ç™»å½•ä¸­ï¼Œè¯·ç¨å...");
                  const result = await response.json();
                  console.log('ç™»å½•å“åº”æ•°æ®:', result); // è°ƒè¯•ä¿¡æ¯
                  if (result.success) {
                    showToast("ç™»å½•æˆåŠŸï¼");
                    // æŠŠè·å–çš„cookieå’ŒmsTokenå¡«å…¥è¡¨å•
                    console.log('æ£€æŸ¥toolsæ•°æ®:', result.tools); // è°ƒè¯•ä¿¡æ¯
                    if (result.tools && result.tools.cookies) {
                      console.log('å¡«å…¥cookies:', result.tools.cookies); // è°ƒè¯•ä¿¡æ¯
                      document.getElementById('cookies').value = result.tools.cookies;
                      // æ›´æ–°ç¼“å­˜
                      douyinFormCache.cookies = result.tools.cookies;
                    }
                    if (result.tools && result.tools.msToken) {
                      console.log('å¡«å…¥msToken:', result.tools.msToken); // è°ƒè¯•ä¿¡æ¯
                      document.getElementById('msToken').value = result.tools.msToken;
                      // æ›´æ–°ç¼“å­˜
                      douyinFormCache.msToken = result.tools.msToken;
                    }
                    // è‡ªåŠ¨ä¿å­˜é…ç½®
                    saveConfigBtn.click();
                  } else {
                    showToast(result.error || "ç™»å½•å¤±è´¥");
                  }
                } catch (error) {
                  console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
                  showToast("ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
                }
              }
              else{
                try {
                  const response = await fetch("/douyin_user_download", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                  });
                  const result = await response.json();
                  if (result.success && result.task_id) {
                    showDownloadModal(); // æ˜¾ç¤ºå¼¹çª—
                    listenDownloadProgress(result.task_id); // å¼€å§‹ç›‘å¬æ—¥å¿—
                  } else {
                    showToast(result.error + result.details || "ä¸‹è½½ä»»åŠ¡å¯åŠ¨å¤±è´¥");
                    hideDownloadModal();
                  }
                } catch (error) {
                  showToast("ä¸‹è½½è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ã€‚");
                  hideDownloadModal();
                }
              }
            });
          }
          
          // æŒ‡å®šè§†é¢‘è¡¨å•å¤„ç†
          const specificForm = document.getElementById('douyin-specific-form');
          const saveConfigBtnSpecific = document.getElementById("saveConfigBtn_specific");
          
          if (saveConfigBtnSpecific && specificForm) {
            saveConfigBtnSpecific.addEventListener("click", async () => {
              const formData = new FormData(specificForm);
              const data = Object.fromEntries(formData.entries());
              // ä¿å­˜å­—æ®µ
              try {
                const response = await fetch("/save_config", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                  showToast("é…ç½®å·²ä¿å­˜ï¼")
                } else {
                  showToast(result.error || "ä¿å­˜å¤±è´¥", 2500);
                }
              } catch (e) {
                showToast("ä¿å­˜è¯·æ±‚å¤±è´¥", 2500);
              }
            });
          }
          
          if (specificForm) {
            specificForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const formData = new FormData(specificForm);
              const data = Object.fromEntries(formData.entries());
              
              // æ£€æŸ¥å¿…å¡«å­—æ®µ
              if (!data.share_url) {
                showToast("è¯·è¾“å…¥è§†é¢‘åˆ†äº«é“¾æ¥");
                return;
              }
              
              if(data.cookies_specific == "" || data.msToken_specific == "") {
                showToast("è¯·å…ˆè¿›è¡Œæ‰«ç ç™»å½•");
                try {
                  const loginData = {
                    cookies: data.cookies_specific,
                    msToken: data.msToken_specific
                  };
                  const response = await fetch("/douyin_login",{
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(loginData)
                  });
                  showToast("ç™»å½•ä¸­ï¼Œè¯·ç¨å...");
                  const result = await response.json();
                  console.log('ç™»å½•å“åº”æ•°æ®:', result); // è°ƒè¯•ä¿¡æ¯
                  if (result.success) {
                    showToast("ç™»å½•æˆåŠŸï¼");
                    // æŠŠè·å–çš„cookieå’ŒmsTokenå¡«å…¥è¡¨å•
                    console.log('æ£€æŸ¥toolsæ•°æ®:', result.tools); // è°ƒè¯•ä¿¡æ¯
                    if (result.tools && result.tools.cookies) {
                      console.log('å¡«å…¥cookies:', result.tools.cookies); // è°ƒè¯•ä¿¡æ¯
                      document.getElementById('cookies_specific').value = result.tools.cookies;
                      // æ›´æ–°ç¼“å­˜
                      douyinFormCache.cookies_specific = result.tools.cookies;
                    }
                    if (result.tools && result.tools.msToken) {
                      console.log('å¡«å…¥msToken:', result.tools.msToken); // è°ƒè¯•ä¿¡æ¯
                      document.getElementById('msToken_specific').value = result.tools.msToken;
                      // æ›´æ–°ç¼“å­˜
                      douyinFormCache.msToken_specific = result.tools.msToken;
                    }
                    // è‡ªåŠ¨ä¿å­˜é…ç½®
                    saveConfigBtnSpecific.click();
                  } else {
                    showToast(result.error || "ç™»å½•å¤±è´¥");
                  }
                } catch (error) {
                  console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
                  showToast("ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
                }
              }
              else{
                try {
                  const requestData = {
                    share_url: data.share_url,
                    cookies: data.cookies_specific,
                    msToken: data.msToken_specific
                  };
                  const response = await fetch("/douyin_specific_download", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestData)
                  });
                  const result = await response.json();
                  if (result.success && result.task_id) {
                    showDownloadModal(); // æ˜¾ç¤ºå¼¹çª—
                    listenDownloadProgress(result.task_id); // å¼€å§‹ç›‘å¬æ—¥å¿—
                  } else {
                    showToast(result.error + (result.details || "") || "ä¸‹è½½ä»»åŠ¡å¯åŠ¨å¤±è´¥");
                    hideDownloadModal();
                  }
                } catch (error) {
                  showToast("ä¸‹è½½è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ã€‚");
                  hideDownloadModal();
                }
              }
            });
          }
        }

        if (page === "chat") {
            restoreChatHistory();

            // ç¡®ä¿äº‹ä»¶ä¸é‡å¤ç»‘å®š
            const sendButton = document.getElementById("sendButton");
            const userInput = document.getElementById("userInput");
            if (sendButton) {
                sendButton.removeEventListener('click', sendMessage);
                sendButton.addEventListener('click', sendMessage);
            }
            if (userInput) {
                userInput.removeEventListener('keydown', handleKeyPress);
                userInput.addEventListener('keydown', handleKeyPress);
            }
            
            const configButton = document.getElementById("configApiButton");
            if (configButton) {
                configButton.addEventListener("click", function () {
                    document.getElementById("configModal").classList.add("active");
                    document.getElementById("modalOverlay").classList.add("active");
    
                    fetch("/get_config")
                    .then(response => response.json())
                    .then(config => {
                        document.getElementById("provider").value = config.chat.provider;
                        updateModelOptions();
                        document.getElementById("model").value = config.chat.model;
                        document.getElementById("apiKey").value = config.chat.apiKeys[config.chat.provider] || "";
                    })
                    .catch(error => {
                        console.error("åŠ è½½é…ç½®å¤±è´¥:", error);
                    });
                });
            }
      
            document.getElementById("closeModal").addEventListener("click", function () {
                document.getElementById("configModal").classList.remove("active");
                document.getElementById("modalOverlay").classList.remove("active");
            });

            const historyButton = document.getElementById("historyButton");
            const historyModal = document.getElementById("historyModal");
            const historyList = document.getElementById("historyList");
            const modalOverlay = document.getElementById("modalOverlay");

            if (historyButton && historyModal && historyList && modalOverlay) {
                historyButton.addEventListener("click", function () {
                    modalOverlay.classList.add("active");
                    historyModal.classList.add("active");

                    // è¯·æ±‚å†å²è®°å½•
                    fetch("/get_history")
                        .then(res => res.json())
                        .then(data => {
                            historyList.innerHTML = "";
                            if (Array.isArray(data)) {
                        data.forEach(item => {
                          const title = item.filename.split("_").slice(1).join("_").replace(".json", "");
                          // å¤–å±‚å®¹å™¨
                          const entry = document.createElement("div");
                          entry.className = "history-item";
                          entry.style.display = "flex";
                          entry.style.justifyContent = "space-between";
                          entry.style.alignItems = "center";

                          // å·¦ä¾§ï¼šç‚¹å‡»åŠ è½½
                          const titleDiv = document.createElement("div");
                          titleDiv.textContent = "ğŸ“„ " + title;
                          titleDiv.style.flex = "1";
                          titleDiv.style.cursor = "pointer";
                          titleDiv.style.paddingRight = "10px";
                          titleDiv.addEventListener("click", async () => {
                            try {
                              if (hasUnsavedChanges && chatHistory.length > 0 && !isSaving) {
                                isSaving = true;
                                try {
                                  await fetch("/save_history", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({
                                      chat: chatHistory,
                                      filename: currentFilename
                                    })
                                  });
                                } finally {
                                  isSaving = false;
                                }
                              }

                              const res = await fetch(`/load_history?filename=${encodeURIComponent(item.filename)}`);
                              const newChat = await res.json();
                              chatHistory = newChat;
                              currentFilename = item.filename;
                              hasUnsavedChanges = false;
                              hasDeletedOriginal = false;

                              // æ¢å¤èŠå¤©è®°å½•ä¿®æ”¹æ ‡å¿—
                              hasUnsavedChanges = false;

                              modalOverlay.classList.remove("active");
                              historyModal.classList.remove("active");
                              restoreChatHistory();
                              enableInput();  // æ¢å¤ç”¨æˆ·è¾“å…¥æ¡†å¯ç”¨çŠ¶æ€
                            } catch (err) {
                              alert("åŠ è½½å¤±è´¥");
                              console.error("åŠ è½½èŠå¤©è®°å½•å¤±è´¥ï¼š", err);
                            }
                          });

                          // å³ä¾§ï¼šåˆ é™¤æŒ‰é’®
                          const deleteBtn = document.createElement("button");
                          deleteBtn.textContent = "ğŸ—‘ï¸";
                          deleteBtn.title = "åˆ é™¤è¯¥èŠå¤©è®°å½•";
                          deleteBtn.style.background = "transparent";
                          deleteBtn.style.border = "none";
                          deleteBtn.style.cursor = "pointer";
                          deleteBtn.style.color = "#cc0000";
                          deleteBtn.style.fontSize = "16px";
                          deleteBtn.style.flexShrink = "0";

                          deleteBtn.addEventListener("click", async (e) => {
                            e.stopPropagation();
                            showDeleteConfirm(`ç¡®è®¤åˆ é™¤ã€Œ${title}ã€è¿™æ¡èŠå¤©è®°å½•ï¼Ÿ`, async () => {
                              try {
                                const res = await fetch("/delete_history", {
                                  method: "POST",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ filename: item.filename })
                                });

                                const result = await res.json();
                                if (res.ok) {
                                  entry.remove();
                                } else {
                                  alert(result.error || "åˆ é™¤å¤±è´¥");
                                }
                              } catch (err) {
                                alert("åˆ é™¤å¤±è´¥");
                                console.error("åˆ é™¤å‡ºé”™ï¼š", err);
                              }

                              enableInput(); // ç¡®ä¿æ¢å¤
                            });
                          });
                        
                          // ç»„è£…åˆ°é¡µé¢
                          entry.appendChild(titleDiv);
                          entry.appendChild(deleteBtn);
                          historyList.appendChild(entry);
                        });
                      } else {
                        historyList.innerHTML = "<p>æœªæ‰¾åˆ°å†å²è®°å½•</p>";
                      }
                    })
                    .catch(err => {
                      historyList.innerHTML = "<p>åŠ è½½å¤±è´¥</p>";
                      console.error("å†å²è®°å½•åŠ è½½å¤±è´¥:", err);
                    });
                    // ç¡®ä¿è¾“å…¥æ¡†æ¢å¤å¯ç”¨
                    const userInput = document.getElementById("userInput");
                    if (userInput) {
                        userInput.disabled = false;
                        userInput.focus();  // è®©ç”¨æˆ·å¯ä»¥ç«‹åˆ»è¾“å…¥æ¶ˆæ¯
                    }
                });

                document.getElementById("closeHistory").addEventListener("click", () => {
                  modalOverlay.classList.remove("active");
                  historyModal.classList.remove("active");
                });
              }
      
              // é…ç½®ç®¡ç†
              const providerSelect = document.getElementById("provider");
              const modelSelect = document.getElementById("model");
              const apiKeyInput = document.getElementById("apiKey");
              const saveButton = document.getElementById("saveConfig");
      
              const models = {
                  "openai": ["gpt-4o", "gpt-4o-mini", "o1"],
                  "deepseek": ["deepseek-chat", "deepseek-reasoner"]
              };
      
              let apiKeys = { "openai": "", "deepseek": "" };
      
              function updateModelOptions() {
                  const selectedProvider = providerSelect.value;
                  modelSelect.innerHTML = "";
                  models[selectedProvider].forEach(model => {
                      let option = document.createElement("option");
                      option.value = model;
                      option.textContent = model;
                      modelSelect.appendChild(option);
                  });
                  apiKeyInput.value = apiKeys[selectedProvider] || "";
              }
      
              providerSelect.addEventListener("change", function () {
                  updateModelOptions();
              });
      
              saveButton.addEventListener("click", function () {
                  const selectedProvider = providerSelect.value;
                  if (!apiKeys[selectedProvider]) {
                      apiKeys[selectedProvider] = "";
                  }
                  apiKeys[selectedProvider] = apiKeyInput.value;
                  const config = {
                    provider: selectedProvider,
                    model: modelSelect.value,
                    apiKeys: apiKeys,
                  };
                  fetch("/save_config", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify(config)
                  })
                  .then(response => response.json())
                  .then(data => {
                    // console.log("é…ç½®å·²ä¿å­˜!");
                    showToast("é…ç½®å·²ä¿å­˜!");
            
                    // å…³é—­é…ç½®çª—å£
                    document.getElementById("configModal").classList.remove("active");
                    document.getElementById("modalOverlay").classList.remove("active");
            
                    // ç¡®ä¿è¾“å…¥æ¡†æ¢å¤å¯ç”¨
                    const userInput = document.getElementById("userInput");
                    if (userInput) {
                        userInput.disabled = false;
                        userInput.focus();  // è®©ç”¨æˆ·å¯ä»¥ç«‹åˆ»è¾“å…¥æ¶ˆæ¯
                    }
                  })
                  .catch(error => {
                      console.error("ä¿å­˜å¤±è´¥:", error);
                  });
              });
      
              // åˆå§‹åŒ–é…ç½®
              fetch("/get_config")
              .then(response => response.json())
              .then(config => {
                  if (config.chat.provider) {
                    providerSelect.value = config.chat.provider;
                  }
                  if (config.chat.apiKeys) {
                    apiKeys = config.chat.apiKeys;
                  }
                  if (config.chat.model) {
                    updateModelOptions();
                    modelSelect.value = config.chat.model;
                  } else {
                    updateModelOptions();
                  }
              })
              .catch(error => {
                  console.error("åŠ è½½é…ç½®å¤±è´¥:", error);
              });

              document.getElementById("newChatButton").addEventListener("click", function () {
                if (hasUnsavedChanges && chatHistory.length > 0) {
                  saveChatHistory();
                }
                clearChatWindow();
                hasUnsavedChanges = false;
              });
        }
    });
  
    // ç›‘å¬å›è½¦é”®
    function handleKeyPress(event) {
      if (event.key === "Enter") {
        event.preventDefault(); // é˜²æ­¢æ¢è¡Œ
        sendMessage();
        const chatBox = document.getElementById('chat-box');
        if (chatBox) {
          chatBox.scrollTop = chatBox.scrollHeight;  // ä¿æŒæ»šåŠ¨æ¡åœ¨åº•éƒ¨
        }
        document.getElementById('userInput')?.focus();  // èšç„¦è¾“å…¥æ¡†
      }
    }

    // å‘é€ç”¨æˆ·æ¶ˆæ¯
    async function sendMessage() {
      const inputField = document.getElementById('userInput');
      const chatBox = document.getElementById('chat-box');
      if (!inputField || !chatBox) return;
      
      // åªè¦ç¼–è¾‘ä¸”è¿˜æ²¡åˆ è¿‡åŸæ–‡ä»¶ï¼Œåˆ™ç«‹å³åˆ é™¤åç«¯æ–‡ä»¶
      if (!hasDeletedOriginal && hasUnsavedChanges === false && currentFilename) {
        fetch("/delete_history", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename: currentFilename })
        }).then(() => {
          hasDeletedOriginal = true;
          currentFilename = null;
        });
      }
      hasUnsavedChanges = true;

      const message = inputField.value.trim();
      if (!message) return;
  
      const summarizedMessage = chatHistory.map(entry => 
          `[${entry.type === "user" ? "User" : "AI"}]: ${entry.text}`
      ).join("\n") + `\n[User]: ${message}`;
  
      // è®°å½•å¹¶æ›´æ–° UI
      chatHistory.push({ type: "user", text: message });
      chatBox.innerHTML += `<div class="user-message">${message}</div>`;
      inputField.value = '';
      chatBox.scrollTop = chatBox.scrollHeight; // ä¿æŒæ»šåŠ¨æ¡åœ¨åº•éƒ¨

      // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
      hasUnsavedChanges = true;
  
      try {
          // åˆ›å»º AI å›å¤çš„ div
          const aiMessageDiv = document.createElement('div');
          aiMessageDiv.classList.add('ai-message');
          chatBox.appendChild(aiMessageDiv);
          
          const response = await fetch('/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: summarizedMessage })  // å‘é€å¸¦æœ‰å¯¹è¯å†å²çš„æ¶ˆæ¯
          });
  
          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          let aiMessage = "";
          let decoder = new TextDecoder();
          let displayedMessage = "";
          let isTyping = false;

          // æ·»åŠ æ‰“å­—æœºæ•ˆæœçš„æ ·å¼å’Œå…‰æ ‡
          aiMessageDiv.style.opacity = '0';
          aiMessageDiv.style.transform = 'translateY(10px)';
          aiMessageDiv.classList.add('typing');
          
          setTimeout(() => {
              aiMessageDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              aiMessageDiv.style.opacity = '1';
              aiMessageDiv.style.transform = 'translateY(0)';
          }, 50);

          // æ‰“å­—æœºæ•ˆæœå‡½æ•°
          const typeWriter = () => {
              if (displayedMessage.length < aiMessage.length) {
                  isTyping = true;
                  displayedMessage = aiMessage.substring(0, displayedMessage.length + 1);
                  let cleanDisplayMessage = displayedMessage.replace(/^\[AI\]:\s*/, '');
                  aiMessageDiv.innerHTML = cleanDisplayMessage + '<span class="typing-cursor">|</span>';
                  chatBox.scrollTop = chatBox.scrollHeight;
                  setTimeout(typeWriter, 30); // è°ƒæ•´æ‰“å­—é€Ÿåº¦
              } else {
                  isTyping = false;
                  let cleanDisplayMessage = displayedMessage.replace(/^\[AI\]:\s*/, '');
                  aiMessageDiv.innerHTML = cleanDisplayMessage;
                  aiMessageDiv.classList.remove('typing');
              }
          };

          let buffer = '';
          while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              const chunk = decoder.decode(value, { stream: true });
              buffer += chunk;
              
              // å¤„ç†Server-Sent Eventsæ ¼å¼çš„æ•°æ®
              const lines = buffer.split('\n');
              buffer = lines.pop() || ''; // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
              
              for (const line of lines) {
                  if (line.startsWith('data: ')) {
                      const text = line.substring(6); // ç§»é™¤'data: 'å‰ç¼€
                      if (text) {
                          aiMessage += text;
                          // å¦‚æœå½“å‰æ²¡æœ‰åœ¨æ‰“å­—ï¼Œå¯åŠ¨æ‰“å­—æœºæ•ˆæœ
                          if (!isTyping) {
                              typeWriter();
                          }
                      }
                  }
              }
          }
          
          // ç¡®ä¿æœ€åçš„å†…å®¹å®Œå…¨æ˜¾ç¤º
          if (displayedMessage.length < aiMessage.length) {
              typeWriter();
          }
  
          // å­˜å‚¨ AI å›å¤åˆ°å†å²è®°å½•
          chatHistory.push({ type: "ai", text: aiMessage });
          chatBox.scrollTop = chatBox.scrollHeight; // æ»šåˆ°åº•
  
      } catch (error) {
          console.error('Chat error:', error);
          chatBox.innerHTML += `<div class="ai-message error">æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·æ£€æŸ¥ API è®¾ç½®æˆ–ç½‘ç»œè¿æ¥ã€‚é”™è¯¯è¯¦æƒ…: ${error.message}</div>`;
      }
      inputField.focus();  // èšç„¦è¾“å…¥æ¡†
    }
  
    // æ¢å¤èŠå¤©è®°å½•
    function restoreChatHistory() {
      const chatBox = document.getElementById('chat-box');
      if (!chatBox) return;
      chatBox.innerHTML = "";
      chatHistory.forEach(entry => {
        if (entry.type === "user") {
          chatBox.innerHTML += `<div class="user-message">${entry.text}</div>`;
        } else {
          // å»é™¤[Assistant]:å‰ç¼€
          let cleanText = entry.text.replace(/^\[Assistant\]:\s*/, '');
          chatBox.innerHTML += `<div class="ai-message">${cleanText}</div>`;
        }
      });
      chatBox.scrollTop = chatBox.scrollHeight; // ä¿æŒæ»šåŠ¨æ¡åœ¨åº•éƒ¨
      document.getElementById('userInput')?.focus();  // èšç„¦è¾“å…¥æ¡†
    }

    // é‡å¯èŠå¤©æ¡†
    function enableInput() {
      const userInput = document.getElementById("userInput");
      const sendButton = document.getElementById("sendButton");

      if (userInput) {
        userInput.disabled = false;
        userInput.focus();

        // é‡æ–°æŒ‚è½½äº‹ä»¶
        userInput.removeEventListener("keydown", handleKeyPress);
        userInput.addEventListener('keydown', handleKeyPress);
      }

      if (sendButton) {
        sendButton.removeEventListener("click", sendMessage);
        sendButton.addEventListener('click', sendMessage);
      }
    }

    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
    function showDeleteConfirm(message, onConfirm) {
      const modal = document.getElementById("deleteConfirmModal");
      const overlay = document.getElementById("modalOverlay");
      const confirmBtn = document.getElementById("confirmDeleteBtn");
      const cancelBtn = document.getElementById("cancelDeleteBtn");
      const text = document.getElementById("deleteConfirmText");

      text.textContent = message;
      modal.classList.add("active");
      overlay.classList.add("active");

      const cleanup = () => {
        modal.classList.remove("active");
        overlay.classList.remove("active");
        confirmBtn.removeEventListener("click", onConfirmHandler);
        cancelBtn.removeEventListener("click", cancelHandler);
      };

      const onConfirmHandler = () => {
        cleanup();
        onConfirm();
      };

      const cancelHandler = () => {
        cleanup();
        enableInput();
      };

      confirmBtn.addEventListener('click', onConfirmHandler);
      cancelBtn.addEventListener('click', cancelHandler);
    }

    // ä¿å­˜èŠå¤©è®°å½•
    function saveChatHistory() {
      if (!hasUnsavedChanges) return;
      if (!chatHistory || chatHistory.length === 0) return;
      if (isSaving) return; // å¦‚æœæ­£åœ¨ä¿å­˜ï¼Œç›´æ¥è¿”å›
      const hasMeaningfulMessage = chatHistory.some(item => item.text && item.text.trim() !== "");
      if (!hasMeaningfulMessage) return;

      isSaving = true; // è®¾ç½®ä¿å­˜æ ‡å¿—
      fetch("/save_history", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat: chatHistory,
          filename: currentFilename
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.filename) currentFilename = data.filename; // åç«¯è¿”å›æ—¶åˆ·æ–°
        hasUnsavedChanges = false;
        hasDeletedOriginal = false;
      })
      .finally(() => {
        isSaving = false; // æ— è®ºæˆåŠŸå¤±è´¥éƒ½é‡ç½®ä¿å­˜æ ‡å¿—
      });
    }
  
    // æ¸…ç©ºèŠå¤©çª—å£å’ŒèŠå¤©è®°å½•æ•°ç»„
    function clearChatWindow() {
        const chatBox = document.getElementById('chat-box');
        if (chatBox) {
            chatBox.innerHTML = ''; // æ¸…ç©ºèŠå¤©çª—å£
        }
        chatHistory = []; // é‡ç½®èŠå¤©è®°å½•
        currentFilename = null;
        hasUnsavedChanges = false;
        hasDeletedOriginal = false;
        document.getElementById('userInput')?.focus();  // èšç„¦è¾“å…¥æ¡†
    }

    window.addEventListener("beforeunload", function (event) {
      // è‡ªåŠ¨ä¿å­˜èŠå¤©è®°å½•
      if (chatHistory.length > 0 && hasUnsavedChanges && !isSaving) {
        isSaving = true; // è®¾ç½®ä¿å­˜æ ‡å¿—é˜²æ­¢é‡å¤
        // ä½¿ç”¨åŒæ­¥fetchè€Œä¸æ˜¯sendBeaconï¼Œç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
        const data = {
          chat: chatHistory,
          filename: currentFilename
        };
        
        // ä½¿ç”¨fetchå‘é€è¯·æ±‚
        fetch("/save_history", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
          keepalive: true  // ç¡®ä¿é¡µé¢å…³é—­æ—¶è¯·æ±‚èƒ½å®Œæˆ
        }).catch(err => console.log('Save failed:', err));
      }
    });
  }); // é—­åˆ DOMContentLoaded äº‹ä»¶ç›‘å¬å™¨
}); // é—­åˆ document.addEventListener

  // ä¸‹è½½å¼¹çª—æ§åˆ¶
  function showDownloadModal() {
      document.getElementById('downloadModal').style.display = 'flex';
  }
  function hideDownloadModal() {
      document.getElementById('downloadModal').style.display = 'none';
      // æ¸…ç©ºæ—¥å¿—
      // document.getElementById('downloadLog').innerHTML = '';
      // document.getElementById('downloadProgress').style.width = "0%";
      // document.getElementById('downloadProgress').innerText = '0%';
  }

  // Socket.io å®æ—¶æ—¥å¿—
  let dlsocket = null;
  function listenDownloadProgress(task_id) {
      if (dlsocket) dlsocket.disconnect();
      dlsocket = io(); // é»˜è®¤è¿æ¥ / (å¦‚åç«¯æ”¹äº†å‘½åç©ºé—´éœ€å¯¹åº”)
      const logBox = document.getElementById('downloadLog');
      const bar = document.getElementById('downloadProgress');
      dlsocket.emit('join_download', {task_id});
      dlsocket.on('dlog', msg => {
          logBox.innerHTML += msg.text + '<br>';
          logBox.scrollTop = logBox.scrollHeight;
      });
      dlsocket.on('dprogress', data => {
          bar.style.width = data.percent + "%";
          bar.innerText = Math.floor(data.percent) + "%";
      });
      dlsocket.on('dfinish', data => {
          bar.style.width = "100%";
          bar.innerText = "100%";
          logBox.innerHTML += '<b>å…¨éƒ¨ä¸‹è½½å®Œæˆ</b><br>';
      });
  }

  // æ‰“å¼€ä¸‹è½½è·¯å¾„
  function openDownloadPath() {
    fetch('/open_download_path', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('å·²æ‰“å¼€ä¸‹è½½è·¯å¾„');
      } else {
        showToast('æ‰“å¼€è·¯å¾„å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('æ‰“å¼€è·¯å¾„å¤±è´¥');
    });
  }

  // è‡ªå®šä¹‰å¼¹çª—
  function showToast(msg, duration = 2000) {
      const toast = document.getElementById('custom-toast');
      toast.innerText = msg;
      toast.style.display = 'block';
      setTimeout(() => toast.classList.add('active'), 5);
      setTimeout(() => {
        toast.classList.remove('active');
        setTimeout(() => toast.style.display = 'none', 350);
      }, duration);
    }
    // æ”¯æŒç‚¹å‡»é®ç½©å…³é—­å½“å‰å¼¹çª—
    document.body.addEventListener("click", function(e) {
      // åªè¦ç‚¹å‡»åœ¨é®ç½©ä¸Šå°±å…³é—­å¼¹çª—
      if (e.target.classList.contains("modal-overlay") || e.target.id === "modalOverlay") {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.modal-overlay, #modalOverlay').forEach(o => o.classList.remove('active'));
      }
    });
</script>
  <div id="custom-toast" style="display:none"></div>
</body>
</html>
