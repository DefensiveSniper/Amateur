<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Amateur</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://kit.fontawesome.com/c0fb207afc.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="container">
    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="logo">
          <img src="/static/images/logo.png" alt="Logo" />
        </div>
        <div class="app-name">Amateur</div>
      </div>

      <div class="sidebar-content">
        <!-- æ·»åŠ ä¸»é¡µæŒ‰é’® -->
        <div class="menu-item" data-page="home">
          <div class="menu-icon"><img src="/static/images/home.png" alt="home" /></div>
          <div class="menu-label">ä¸»é¡µ</div>
        </div>
        <!-- æ·»åŠ åŠŸèƒ½æŒ‰é’® -->
        <div class="menu-item" data-page="tools">
          <div class="menu-icon"><img src="/static/images/tool.png" alt="tool" /></div>
          <div class="menu-label">åŠŸèƒ½</div>
        </div>
        <!-- æ·»åŠ  AI å¯¹è¯æŒ‰é’® -->
        <div class="menu-item" data-page="chat">
          <div class="menu-icon"><img src="/static/images/chat.png" alt="chat" /></div>
          <div class="menu-label">AI å¯¹è¯</div>
        </div>
        <!-- æ·»åŠ å…³äºæŒ‰é’® -->
        <div class="menu-item" data-page="about">
          <div class="menu-icon"><img src="/static/images/about.png" alt="about" /></div>
          <div class="menu-label">å…³äº</div>
        </div>
      </div>
    </aside>

    <!-- å³ä¾§ä¸»è¦å†…å®¹åŒº -->
    <main class="main-box">
      <div class="main-content"></div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script>
    let chatHistory = []; // å­˜å‚¨èŠå¤©å†…å®¹
    let currentFilename = null;    // å½“å‰èŠå¤©çš„å†å²æ–‡ä»¶å
    let hasUnsavedChanges = false; // å½“å‰èŠå¤©å†…å®¹æ˜¯å¦æœ‰æœªä¿å­˜æ›´æ”¹
    let hasDeletedOriginal = false;// æ˜¯å¦å·²ç»åˆ é™¤è¿‡åŸæœ‰èŠå¤©æ–‡ä»¶ï¼ˆé˜²æ­¢é‡å¤åˆ ï¼‰

    document.addEventListener('DOMContentLoaded', function() {
      const menuItems = document.querySelectorAll('.menu-item');
      const mainContent = document.querySelector('.main-content');
    
      const pages = {
        home: `<iframe src="https://hzihao.icu" class="iframe-content"></iframe>
                <div class="main-tail">
                  <a href="https://hzihao.icu" target="_blank"><p>Amateurå‘ç”µçš„åœ°æ–¹</p></a>
                </div>`,
        tools: `<div class="main-header fade-in">
                  <h2>ä¸€äº›å¯èƒ½æœ‰ç”¨çš„ç©æ„</h2>
                  <h3>ä½†æ˜¯è¿˜æ²¡æœ‰æƒ³æ³•</h3>
                </div>
                <div class="cards-wrapper fade-in">
                  <div class="card fade-in" style="max-width: 480px; margin: 0 auto; padding: 30px 30px 20px 30px; flex-direction: column; align-items: stretch;">
                    <h2 style="margin: 0 auto; text-align: center;">æŠ–éŸ³è§†é¢‘ä¸‹è½½</h2>
                    <form id="douyin-download-form" style="display: flex; flex-direction: column; gap: 22px;">
                      <label>
                        <span style="font-weight:500;">sec_user_idï¼š</span>
                        <input type="text" name="sec_user_id" id="sec_user_id" class="input-field" placeholder="è¯·è¾“å…¥sec_user_id" required>
                      </label>
                      <label>
                        <span style="font-weight:500;">cookiesï¼š</span>
                        <input type="text" name="cookies" id="cookies" class="input-field" placeholder="è¯·è¾“å…¥cookies" required>
                      </label>
                      <label>
                        <span style="font-weight:500;">user_agentï¼š</span>
                        <input type="text" name="user_agent" id="user_agent" class="input-field" placeholder="è¯·è¾“å…¥user_agent" required>
                      </label>
                      <label>
                        <span style="font-weight:500;">æœ€å¤§ä¸‹è½½ä¸ªæ•°ï¼š</span>
                        <input type="number" name="max_dloads" id="max_dloads" class="input-field" placeholder="è¯·è¾“å…¥æœ€å¤§ä¸‹è½½ä¸ªæ•°" min="1" required value="10">
                      </label>
                      <button type="submit" id="start_dload" class="main-btn">å¼€å§‹ä¸‹è½½</button>
                    </form>
                  </div>
                  <div class="card"><img src="/static/images/ela.png" alt="å›¾ç‰‡2"></div>
                  <div class="card"><img src="/static/images/ela.png" alt="å›¾ç‰‡3"></div>
                </div>`,
        chat: `<div class="chat-container">
                <div class="button-container">
                  <button class="button-item" id="newChatButton">
                    <div class="button-icon">
                      <img src="/static/images/newchat.png" alt="newchat">
                    </div>
                    æ–°èŠå¤©
                  </button>

                  <button class="button-item" id="configApiButton">
                    <div class="button-icon">
                      <img src="/static/images/setting.png" alt="setting">
                    </div>
                    é…ç½®
                  </button>

                  <button class="button-item" id="historyButton">
                    <div class="button-icon">
                      <img src="/static/images/history.png" alt="history">
                    </div>
                    å›å¿†å½•
                  </button>
                </div>
                <div class="chat-box" id="chat-box"></div>
                <div class="chat-input">
                    <input type="text" id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜">
                    <button id="sendButton">å‘é€</button>
                </div>
            </div>
            <!-- é…ç½®æ¨¡æ€æ¡† -->
            <div class="modal-overlay" id="modalOverlay"></div>
            <div class="modal" id="configModal">
                <h3>API é…ç½®</h3>
                <label>æä¾›æ–¹ï¼š
                    <select id="provider">
                        <option value="openai">OpenAI</option>
                        <option value="deepseek">DeepSeek</option> 
                    </select>
                </label>
                <br><br>
                <label>æ¨¡å‹ï¼š
                    <select id="model">
                        <!-- é»˜è®¤é€‰é¡¹ -->
                    </select>
                </label>
                <br><br>
                <label>
                    API Key:
                    <input type="text" id="apiKey" placeholder="è¾“å…¥API Key">
                </label>
                <br><br>
                <button id="saveConfig">ä¿å­˜</button>
                <button id="closeModal">å–æ¶ˆ</button>
            </div>
            <!-- å›å¿†å½•æ¨¡æ€æ¡† -->
            <div class="modal" id="historyModal">
              <h3>èŠå¤©å†å²</h3>
              <div id="historyList" style="max-height: 300px; overflow-y: auto; margin: 10px 0;"></div>
              <button id="closeHistory">å…³é—­</button>
            </div>
            <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
            <div class="modal" id="deleteConfirmModal">
              <h3 id="deleteConfirmText">ç¡®è®¤åˆ é™¤ï¼Ÿ</h3>
              <button id="confirmDeleteBtn">ç¡®è®¤</button>
              <button id="cancelDeleteBtn">å–æ¶ˆ</button>
            </div>
            `,
        about: `<div class="page-content fade-in">
                  <div class="main-header"><h2>ä¸€äº›å¯èƒ½æœ‰ç”¨çš„ä¿¡æ¯</h2></div>
                  <div class="about-content"><p>æœ¬åº”ç”¨ç”±Amateurä¸ªäººç‹¬ç«‹ä½¿ç”¨AIå¼€å‘ã€‚</p></div>
                </div>`,
      };

    // é»˜è®¤æ˜¾ç¤ºä¸»é¡µ
    mainContent.innerHTML = pages.home;
    menuItems[0].classList.add('active');
    
    // ç»‘å®šå¯¼èˆªæ ç‚¹å‡»äº‹ä»¶
    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        menuItems.forEach(mi => mi.classList.remove('active'));
        item.classList.add('active');
        const page = item.getAttribute('data-page');

        mainContent.innerHTML = "";
        setTimeout(() => {
          mainContent.innerHTML = pages[page];

          if (page ==="tools") {
            // é…ç½®ç®¡ç†
            const cookies = document.getElementById("cookies")
            const user_agent = document.getElementById("user_agent")

            fetch('/get_config')
              .then(res => res.json())
              .then(data => {
                if(data.cookie_str) cookies.value = data.cookie_str
                if(data.user_agent) user_agent.value = data.user_agent
              })
              .catch(error => {
                  console.error("åŠ è½½é…ç½®å¤±è´¥:", error);
              });

            const form = document.getElementById("douyin-download-form");
            if (form) {
              form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                try {
                  const response = await fetch("/douyin_download", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                  });
                  const result = await response.json();
                  if (result.success) {
                    alert(result.success);
                  } else {
                    alert(result.error + result.details);
                  }
                } catch (error) {
                  console.error("ä¸‹è½½è¯·æ±‚å¤±è´¥ï¼š", error);
                  alert("ä¸‹è½½è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ã€‚");
                }
              });
            }
          }

          if (page === "chat") {
              restoreChatHistory();

              // ç¡®ä¿äº‹ä»¶ä¸é‡å¤ç»‘å®š
              const sendButton = document.getElementById("sendButton");
              const userInput = document.getElementById("userInput");
              if (sendButton) {
                  sendButton.removeEventListener("click", sendMessage);
                  sendButton.addEventListener("click", sendMessage);
              }
              if (userInput) {
                  userInput.removeEventListener("keydown", handleKeyPress);
                  userInput.addEventListener("keydown", handleKeyPress);
                  userInput.disabled = false;
                  userInput.focus();
              }
      
              const configButton = document.getElementById("configApiButton");
              if (configButton) {
                  configButton.addEventListener("click", function () {
                      document.getElementById("configModal").classList.add("active");
                      document.getElementById("modalOverlay").classList.add("active");
      
                      fetch("/get_config")
                          .then(response => response.json())
                          .then(config => {
                              document.getElementById("provider").value = config.provider;
                              updateModelOptions();
                              document.getElementById("model").value = config.model;
                              document.getElementById("apiKey").value = config.apiKeys[config.provider] || "";
                          })
                          .catch(error => {
                              console.error("åŠ è½½é…ç½®å¤±è´¥:", error);
                          });
                  });
              }
      
              document.getElementById("closeModal").addEventListener("click", function () {
                  document.getElementById("configModal").classList.remove("active");
                  document.getElementById("modalOverlay").classList.remove("active");
              });

              const historyButton = document.getElementById("historyButton");
              const historyModal = document.getElementById("historyModal");
              const historyList = document.getElementById("historyList");
              const modalOverlay = document.getElementById("modalOverlay");

              if (historyButton && historyModal && historyList && modalOverlay) {
                historyButton.addEventListener("click", function () {
                  modalOverlay.classList.add("active");
                  historyModal.classList.add("active");

                  // è¯·æ±‚å†å²è®°å½•
                  fetch("/get_history")
                    .then(res => res.json())
                    .then(data => {
                      historyList.innerHTML = "";
                      if (Array.isArray(data)) {
                        data.forEach(item => {
                          const title = item.filename.split("_").slice(1).join("_").replace(".json", "");
                          // å¤–å±‚å®¹å™¨
                          const entry = document.createElement("div");
                          entry.className = "history-item";
                          entry.style.display = "flex";
                          entry.style.justifyContent = "space-between";
                          entry.style.alignItems = "center";

                          // å·¦ä¾§ï¼šç‚¹å‡»åŠ è½½
                          const titleDiv = document.createElement("div");
                          titleDiv.textContent = "ğŸ“„ " + title;
                          titleDiv.style.flex = "1";
                          titleDiv.style.cursor = "pointer";
                          titleDiv.style.paddingRight = "10px";
                          titleDiv.addEventListener("click", async () => {
                            try {
                              if (hasUnsavedChanges && chatHistory.length > 0) {
                                await fetch("/save_history", {
                                  method: "POST",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify(chatHistory)
                                });
                              }

                              const res = await fetch(`/load_history?filename=${encodeURIComponent(item.filename)}`);
                              const newChat = await res.json();
                              chatHistory = newChat;
                              currentFilename = item.filename;
                              hasUnsavedChanges = false;
                              hasDeletedOriginal = false;

                              // æ¢å¤èŠå¤©è®°å½•ä¿®æ”¹æ ‡å¿—
                              hasUnsavedChanges = false;

                              modalOverlay.classList.remove("active");
                              historyModal.classList.remove("active");
                              restoreChatHistory();
                              enableInput();  // æ¢å¤ç”¨æˆ·è¾“å…¥æ¡†å¯ç”¨çŠ¶æ€
                            } catch (err) {
                              alert("åŠ è½½å¤±è´¥");
                              console.error("åŠ è½½èŠå¤©è®°å½•å¤±è´¥ï¼š", err);
                            }
                          });

                          // å³ä¾§ï¼šåˆ é™¤æŒ‰é’®
                          const deleteBtn = document.createElement("button");
                          deleteBtn.textContent = "ğŸ—‘ï¸";
                          deleteBtn.title = "åˆ é™¤è¯¥èŠå¤©è®°å½•";
                          deleteBtn.style.background = "transparent";
                          deleteBtn.style.border = "none";
                          deleteBtn.style.cursor = "pointer";
                          deleteBtn.style.color = "#cc0000";
                          deleteBtn.style.fontSize = "16px";
                          deleteBtn.style.flexShrink = "0";

                          deleteBtn.addEventListener("click", async (e) => {
                            e.stopPropagation();
                            showDeleteConfirm(`ç¡®è®¤åˆ é™¤ã€Œ${title}ã€è¿™æ¡èŠå¤©è®°å½•ï¼Ÿ`, async () => {
                              try {
                                const res = await fetch("/delete_history", {
                                  method: "POST",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ filename: item.filename })
                                });

                                const result = await res.json();
                                if (res.ok) {
                                  entry.remove();
                                } else {
                                  alert(result.error || "åˆ é™¤å¤±è´¥");
                                }
                              } catch (err) {
                                alert("åˆ é™¤å¤±è´¥");
                                console.error("åˆ é™¤å‡ºé”™ï¼š", err);
                              }

                              enableInput(); // ç¡®ä¿æ¢å¤
                            });
                          }
                          );
                        
                          // ç»„è£…åˆ°é¡µé¢
                          entry.appendChild(titleDiv);
                          entry.appendChild(deleteBtn);
                          historyList.appendChild(entry);
                        });
                      } else {
                        historyList.innerHTML = "<p>æœªæ‰¾åˆ°å†å²è®°å½•</p>";
                      }
                    })
                    .catch(err => {
                      historyList.innerHTML = "<p>åŠ è½½å¤±è´¥</p>";
                      console.error("å†å²è®°å½•åŠ è½½å¤±è´¥:", err);
                    });
                    // ç¡®ä¿è¾“å…¥æ¡†æ¢å¤å¯ç”¨
                    const userInput = document.getElementById("userInput");
                    if (userInput) {
                        userInput.disabled = false;
                        userInput.focus();  // è®©ç”¨æˆ·å¯ä»¥ç«‹åˆ»è¾“å…¥æ¶ˆæ¯
                    }
                });

                document.getElementById("closeHistory").addEventListener("click", () => {
                  modalOverlay.classList.remove("active");
                  historyModal.classList.remove("active");
                });
              }
      
              // é…ç½®ç®¡ç†
              const providerSelect = document.getElementById("provider");
              const modelSelect = document.getElementById("model");
              const apiKeyInput = document.getElementById("apiKey");
              const saveButton = document.getElementById("saveConfig");
      
              const models = {
                  "openai": ["gpt-4o", "gpt-4o-mini", "o1"],
                  "deepseek": ["deepseek-chat", "deepseek-reasoner"]
              };
      
              let apiKeys = { "openai": "", "deepseek": "" };
      
              function updateModelOptions() {
                  const selectedProvider = providerSelect.value;
                  modelSelect.innerHTML = "";
                  models[selectedProvider].forEach(model => {
                      let option = document.createElement("option");
                      option.value = model;
                      option.textContent = model;
                      modelSelect.appendChild(option);
                  });
                  apiKeyInput.value = apiKeys[selectedProvider] || "";
              }
      
              providerSelect.addEventListener("change", function () {
                  updateModelOptions();
              });
      
              saveButton.addEventListener("click", function () {
                  const selectedProvider = providerSelect.value;
                  if (!apiKeys[selectedProvider]) {
                      apiKeys[selectedProvider] = "";
                  }
                  apiKeys[selectedProvider] = apiKeyInput.value;
                  const config = {
                      provider: selectedProvider,
                      model: modelSelect.value,
                      apiKeys: apiKeys
                  };
                  fetch("/save_config", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify(config)
                  })
                  .then(response => response.json())
                  .then(data => {
                    console.log("é…ç½®å·²ä¿å­˜!");
            
                    // å…³é—­é…ç½®çª—å£
                    document.getElementById("configModal").classList.remove("active");
                    document.getElementById("modalOverlay").classList.remove("active");
            
                    // ç¡®ä¿è¾“å…¥æ¡†æ¢å¤å¯ç”¨
                    const userInput = document.getElementById("userInput");
                    if (userInput) {
                        userInput.disabled = false;
                        userInput.focus();  // è®©ç”¨æˆ·å¯ä»¥ç«‹åˆ»è¾“å…¥æ¶ˆæ¯
                    }
                  })
                  .catch(error => {
                      console.error("ä¿å­˜å¤±è´¥:", error);
                  });
                }
              );
      
              // åˆå§‹åŒ–é…ç½®
              fetch("/get_config")
              .then(response => response.json())
              .then(data => {
                  if (data.provider) {
                    providerSelect.value = data.provider;
                  }
                  if (data.apiKeys) {
                    apiKeys = data.apiKeys;
                  }
                  if (data.model) {
                    updateModelOptions();
                    modelSelect.value = data.model;
                  } else {
                    updateModelOptions();
                  }
              })
              .catch(error => {
                  console.error("åŠ è½½é…ç½®å¤±è´¥:", error);
              });

              document.getElementById("newChatButton").addEventListener("click", function () {
                if (hasUnsavedChanges && chatHistory.length > 0) {
                  saveChatHistory();
                }
                clearChatWindow();
                hasUnsavedChanges = false;
              });
          }
      }, 50);      
      });
    });
  
    // ç›‘å¬å›è½¦é”®
    function handleKeyPress(event) {
      if (event.key === "Enter") {
        event.preventDefault(); // é˜²æ­¢æ¢è¡Œ
        sendMessage();
        chatBox.scrollTop = chatBox.scrollHeight;  // ä¿æŒæ»šåŠ¨æ¡åœ¨åº•éƒ¨
        document.getElementById('userInput')?.focus();  // èšç„¦è¾“å…¥æ¡†
      }
    }

    // å‘é€ç”¨æˆ·æ¶ˆæ¯
    async function sendMessage() {
      const inputField = document.getElementById('userInput');
      const chatBox = document.getElementById('chat-box');
      if (!inputField || !chatBox) return;
      
      // åªè¦ç¼–è¾‘ä¸”è¿˜æ²¡åˆ è¿‡åŸæ–‡ä»¶ï¼Œåˆ™ç«‹å³åˆ é™¤åç«¯æ–‡ä»¶
      if (!hasDeletedOriginal && hasUnsavedChanges === false && currentFilename) {
        fetch("/delete_history", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename: currentFilename })
        }).then(() => {
          hasDeletedOriginal = true;
          currentFilename = null;
        });
      }
      hasUnsavedChanges = true;

      const message = inputField.value.trim();
      if (!message) return;
  
      const summarizedMessage = chatHistory.map(entry => 
          `[${entry.type === "user" ? "User" : "AI"}]: ${entry.text}`
      ).join("\n") + `\n[User]: ${message}`;
  
      // è®°å½•å¹¶æ›´æ–° UI
      chatHistory.push({ type: "user", text: message });
      chatBox.innerHTML += `<div class="user-message">ğŸ§‘ï¼š${message}</div>`;
      inputField.value = '';

      // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
      hasUnsavedChanges = true;
  
      try {
          const response = await fetch('http://127.0.0.1:6969/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: summarizedMessage })  // å‘é€å¸¦æœ‰å¯¹è¯å†å²çš„æ¶ˆæ¯
          });
  
          const reader = response.body.getReader();
          let aiMessage = "";
          let decoder = new TextDecoder();
  
          // åˆ›å»º AI å›å¤çš„ div
          const aiMessageDiv = document.createElement('div');
          aiMessageDiv.classList.add('ai-message');
          chatBox.appendChild(aiMessageDiv);

          let firstChunk = true;

          while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              const chunk = decoder.decode(value, { stream: true });
              aiMessage += chunk;

              if (firstChunk) {
                  aiMessageDiv.innerText = aiMessage;
                  firstChunk = false;
              } else {
                  aiMessageDiv.innerText = aiMessage;
              }

              chatBox.scrollTop = chatBox.scrollHeight; // ä¿æŒæ»šåŠ¨æ¡åœ¨åº•éƒ¨
          }
  
          // å­˜å‚¨ AI å›å¤åˆ°å†å²è®°å½•
          chatHistory.push({ type: "ai", text: aiMessage });
          chatBox.scrollTop = chatBox.scrollHeight; // æ»šåˆ°åº•
  
      } catch (error) {
          chatBox.innerHTML += `<div class="ai-message error">æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·æ£€æŸ¥ API è®¾ç½®æˆ–ç½‘ç»œè¿æ¥ã€‚</div>`;
      }
      inputField.focus();  // èšç„¦è¾“å…¥æ¡†
    }
  
    // æ¢å¤èŠå¤©è®°å½•
    function restoreChatHistory() {
      const chatBox = document.getElementById('chat-box');
      if (!chatBox) return;
      chatBox.innerHTML = "";
      chatHistory.forEach(entry => {
        if (entry.type === "user") {
          chatBox.innerHTML += `<div class="user-message">${entry.text}</div>`;
        } else {
          chatBox.innerHTML += `<div class="ai-message">${entry.text}</div>`;
        }
      });
      chatBox.scrollTop = chatBox.scrollHeight; // ä¿æŒæ»šåŠ¨æ¡åœ¨åº•éƒ¨
      document.getElementById('userInput')?.focus();  // èšç„¦è¾“å…¥æ¡†
    }

    // é‡å¯èŠå¤©æ¡†
    function enableInput() {
      const userInput = document.getElementById("userInput");
      const sendButton = document.getElementById("sendButton");

      if (userInput) {
        userInput.disabled = false;
        userInput.focus();

        // é‡æ–°æŒ‚è½½äº‹ä»¶
        userInput.removeEventListener("keydown", handleKeyPress);
        userInput.addEventListener("keydown", handleKeyPress);
      }

      if (sendButton) {
        sendButton.removeEventListener("click", sendMessage);
        sendButton.addEventListener("click", sendMessage);
      }
    }

    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
    function showDeleteConfirm(message, onConfirm) {
      const modal = document.getElementById("deleteConfirmModal");
      const overlay = document.getElementById("modalOverlay");
      const confirmBtn = document.getElementById("confirmDeleteBtn");
      const cancelBtn = document.getElementById("cancelDeleteBtn");
      const text = document.getElementById("deleteConfirmText");

      text.textContent = message;
      modal.classList.add("active");
      overlay.classList.add("active");

      const cleanup = () => {
        modal.classList.remove("active");
        overlay.classList.remove("active");
        confirmBtn.removeEventListener("click", onConfirmHandler);
        cancelBtn.removeEventListener("click", cancelHandler);
      };

      const onConfirmHandler = () => {
        cleanup();
        onConfirm();
      };

      const cancelHandler = () => {
        cleanup();
        enableInput();
      };

      confirmBtn.addEventListener("click", onConfirmHandler);
      cancelBtn.addEventListener("click", cancelHandler);
    }

    // ä¿å­˜èŠå¤©è®°å½•
    function saveChatHistory() {
    if (!hasUnsavedChanges) return;
    if (!chatHistory || chatHistory.length === 0) return;
    const hasMeaningfulMessage = chatHistory.some(item => item.text && item.text.trim() !== "");
    if (!hasMeaningfulMessage) return;

    fetch("/save_history", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat: chatHistory,
        filename: currentFilename
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.filename) currentFilename = data.filename; // åç«¯è¿”å›æ—¶åˆ·æ–°
      hasUnsavedChanges = false;
      hasDeletedOriginal = false;
    });
  }
  
    // æ¸…ç©ºèŠå¤©çª—å£å’ŒèŠå¤©è®°å½•æ•°ç»„
    function clearChatWindow() {
        const chatBox = document.getElementById('chat-box');
        if (chatBox) {
            chatBox.innerHTML = ""; // æ¸…ç©ºèŠå¤©çª—å£
        }
        chatHistory = []; // é‡ç½®èŠå¤©è®°å½•
        currentFilename = null;
        hasUnsavedChanges = false;
        hasDeletedOriginal = false;
        document.getElementById('userInput')?.focus();  // èšç„¦è¾“å…¥æ¡†
    }
  });

  window.addEventListener("beforeunload", function (event) {
    // è‡ªåŠ¨ä¿å­˜èŠå¤©è®°å½•
    if (chatHistory.length > 0) {
      navigator.sendBeacon("/save_history", new Blob(
        [JSON.stringify(chatHistory)], 
        { type: "application/json" }
      ));
    }
  });
    </script>    
  </body>
</html>
